// main.dart
import 'package:flutter/material.dart';

void main() {
  runApp(const XiaoChuApp());
}

class XiaoChuApp extends StatefulWidget {
  const XiaoChuApp({super.key});
  @override
  State<XiaoChuApp> createState() => _XiaoChuAppState();
}

class _XiaoChuAppState extends State<XiaoChuApp> {
  bool _isEnglish = false;

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: _isEnglish ? 'Xiao Chu Takeaway' : '初見小廚外賣',
      theme: ThemeData(primarySwatch: Colors.teal),
      home: MenuScreen(
        isEnglish: _isEnglish,
        toggleLang: () => setState(() => _isEnglish = !_isEnglish),
      ),
    );
  }
}

// ========================================
// 菜單資料 (直接從你提供的餐牌整理)
// ========================================
final Map<String, List<Map<String, dynamic>>> menuData = {
  "飯類 Rice": [
    {"zh": "滑蛋雞柳飯(可加辣)", "en": "Fried Egg Chicken Fillet Rice", "price": 38},
    {"zh": "滑蛋浦燒鰻魚飯", "en": "Fried Egg Eel Rice", "price": 53},
    {"zh": "特盛浦燒鰻魚飯", "en": "Large Kabayaki Eel Rice", "price": 78},
    {"zh": "豚肉丼飯(配太陽蛋)", "en": "Pork Rice Bowl w/ Egg", "price": 45},
    {"zh": "麻辣豚肉丼飯", "en": "Sichuan Spicy Pork Rice Bowl", "price": 45},
    {"zh": "咖喱/蕃茄豚肉丼飯", "en": "Curry/Tomato Pork Rice Bowl", "price": 45},
    {"zh": "泡菜辣炒豚肉飯", "en": "Kimchi Spicy Pork Rice", "price": 48},
    {"zh": "黑松露滑蛋蝦仁飯", "en": "Black Truffle Shrimp Rice", "price": 46},
    {"zh": "咖喱炸雞飯", "en": "Curry Fried Chicken Rice", "price": 42},
    {"zh": "咖喱吉列蠔飯", "en": "Curry Oyster Rice", "price": 56},
    {"zh": "白汁香草煎雞飯", "en": "Cream Herb Chicken Rice", "price": 43},
    {"zh": "照燒香煎蠔配豚肉飯", "en": "Teriyaki Oyster & Pork Rice", "price": 63},
  ],
  "烏冬 Udon": [
    {"zh": "咖喱炸雞烏冬", "en": "Curry Fried Chicken Udon", "price": 44},
    {"zh": "咖喱吉列豬扒烏冬", "en": "Curry Pork Cutlet Udon", "price": 46},
    {"zh": "咖喱石斑魚烏冬", "en": "Curry Grouper Udon", "price": 49},
    {"zh": "咖喱吉列蠔烏冬", "en": "Curry Oyster Udon", "price": 60},
  ],
  "焗飯 Baked Rice": [
    {"zh": "芝士焗白汁雞皇飯", "en": "Cheese Baked Chicken Rice", "price": 48},
    {"zh": "芝士焗煙三文魚牛油果飯", "en": "Cheese Baked Salmon Avocado Rice", "price": 59},
  ],
  "意粉 Spaghetti": [
    {"zh": "特濃番茄雞肉炒意粉", "en": "Tomato Chicken Spaghetti", "price": 46},
    {"zh": "白汁煙三文魚吞拿魚意粉", "en": "Cream Salmon Tuna Spaghetti", "price": 56},
    {"zh": "蒜香帶子蝦仁炒意粉", "en": "Garlic Scallop Shrimp Spaghetti", "price": 60},
  ],
  "薄餅 PIZZA": [
    {"zh": "夏威夷PIZZA (10吋/12吋)", "en": "Hawaiian Pizza", "price": "78/98"},
    {"zh": "吞拿魚PIZZA", "en": "Tuna Pizza", "price": "88/108"},
    {"zh": "麻辣烤雞PIZZA", "en": "Spicy Grilled Chicken Pizza", "price": "98/118"},
    {"zh": "煙三文魚PIZZA", "en": "Smoked Salmon Pizza", "price": "118/138"},
  ],
  "小食 Snacks": [
    {"zh": "招牌鹽酥雞(可加辣)", "en": "Signature Popcorn Chicken", "price": 30},
    {"zh": "炸雞中翼 4隻/6隻", "en": "Fried Chicken Wings", "price": "28/38"},
    {"zh": "唐揚炸雞 (6件)", "en": "Japanese Karaage Chicken", "price": 42},
    {"zh": "炸吉列蠔 (4件)", "en": "Fried Oysters", "price": 48},
    {"zh": "炸物拼盤", "en": "Fried Platter", "price": 108},
  ],
  "飲品 Drinks": [
    {"zh": "熱/凍 即磨咖啡", "en": "Hot/Iced Fresh Coffee", "price": "13/15"},
    {"zh": "400次手打鮮奶咖啡", "en": "Dalgona Coffee", "price": 25},
    {"zh": "生椰拿鐵", "en": "Coconut Latte", "price": 25},
    {"zh": "泰式奶茶", "en": "Thai Milk Tea", "price": "18/20"},
    {"zh": "抹茶拿鐵", "en": "Matcha Latte", "price": "18/20"},
  ],
};

// ========================================
// 主畫面
// ========================================
class MenuScreen extends StatefulWidget {
  final bool isEnglish;
  final VoidCallback toggleLang;

  const MenuScreen({required this.isEnglish, required this.toggleLang, super.key});

  @override
  State<MenuScreen> createState() => _MenuScreenState();
}

class _MenuScreenState extends State<MenuScreen> {
  final Map<String, int> _cart = {}; // key: "分類|名稱" , value: 數量

  @override
  Widget build(BuildContext context) {
    int totalItems = _cart.values.fold(0, (a, b) => a + b);
    double totalPrice = _calculateTotal();

    return Scaffold(
      appBar: AppBar(
        title: Text(widget.isEnglish ? 'Xiao Chu Takeaway' : '小廚外賣'),
        actions: [
          IconButton(
            icon: const Icon(Icons.language),
            onPressed: widget.toggleLang,
          ),
          Stack(
            children: [
              IconButton(
                icon: const Icon(Icons.shopping_cart),
                onPressed: () => Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (_) => CartScreen(cart: _cart, isEnglish: widget.isEnglish),
                  ),
                ),
              ),
              if (totalItems > 0)
                Positioned(
                  right: 8,
                  top: 8,
                  child: CircleAvatar(
                    radius: 10,
                    backgroundColor: Colors.red,
                    child: Text('$totalItems', style: const TextStyle(fontSize: 12)),
                  ),
                ),
            ],
          ),
        ],
      ),
      body: ListView.builder(
        padding: const EdgeInsets.all(12),
        itemCount: menuData.keys.length,
        itemBuilder: (context, index) {
          String category = menuData.keys.elementAt(index);
          return CategorySection(
            category: category,
            items: menuData[category]!,
            isEnglish: widget.isEnglish,
            cart: _cart,
            onUpdate: () => setState(() {}),
          );
        },
      ),
      floatingActionButton: totalItems > 0
          ? FloatingActionButton.extended(
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (_) => CheckoutScreen(
                      cart: _cart,
                      totalPrice: totalPrice,
                      isEnglish: widget.isEnglish,
                    ),
                  ),
                );
              },
              label: Text(widget.isEnglish
                  ? 'Checkout \$${totalPrice.toStringAsFixed(0)}'
                  : '結帳 \$${totalPrice.toStringAsFixed(0)}'),
              icon: const Icon(Icons.payment),
            )
          : null,
    );
  }

  double _calculateTotal() {
    double sum = 0;
    _cart.forEach((key, qty) {
      final parts = key.split('|');
      final category = parts[0];
      final nameZh = parts[1];
      final item = menuData[category]!
          .firstWhere((e) => e['zh'] == nameZh, orElse: () => {"price": 0});
      var price = item['price'];
      if (price is String && price.contains('/')) {
        price = int.parse(price.split('/').first);
      }
      sum += (price as num) * qty;
    });
    return sum;
  }
}

// ========================================
// 每個分類區塊
// ========================================
class CategorySection extends StatelessWidget {
  final String category;
  final List<Map<String, dynamic>> items;
  final bool isEnglish;
  final Map<String, int> cart;
  final VoidCallback onUpdate;

  const CategorySection({
    required this.category,
    required this.items,
    required this.isEnglish,
    required this.cart,
    required this.onUpdate,
    super.key,
  });

  @override
  Widget build(BuildContext context) {
    String title = isEnglish
        ? category.split(' ').last
        : category.split(' ').first;

    return Card(
      margin: const EdgeInsets.symmetric(vertical: 8),
      child: ExpansionTile(
        title: Text(title, style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
        children: items.map((item) {
          String key = '$category|${item['zh']}';
          int qty = cart[key] ?? 0;

          return ListTile(
            title: Text(isEnglish ? item['en'] : item['zh']),
            subtitle: Text(
              item['price'] is String
                  ? 'MOP ${item['price']}'
                  : 'MOP ${item['price']}',
              style: const TextStyle(color: Colors.green, fontWeight: FontWeight.bold),
            ),
            trailing: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                IconButton(
                  icon: const Icon(Icons.remove_circle_outline),
                  onPressed: qty <= 0
                      ? null
                      : () {
                          cart[key] = qty - 1;
                          if (cart[key] == 0) cart.remove(key);
                          onUpdate();
                        },
                ),
                Text('$qty', style: const TextStyle(fontSize: 18)),
                IconButton(
                  icon: const Icon(Icons.add_circle_outline),
                  onPressed: () {
                    cart[key] = qty + 1;
                    onUpdate();
                  },
                ),
              ],
            ),
          );
        }).toList(),
      ),
    );
  }
}

// ========================================
// 購物車頁面
// ========================================
class CartScreen extends StatelessWidget {
  final Map<String, int> cart;
  final bool isEnglish;

  const CartScreen({required this.cart, required this.isEnglish, super.key});

  @override
  Widget build(BuildContext context) {
    if (cart.isEmpty) {
      return Scaffold(
        appBar: AppBar(title: Text(isEnglish ? 'Cart' : '購物車')),
        body: Center(child: Text(isEnglish ? 'Cart is empty' : '購物車是空的')),
      );
    }

    return Scaffold(
      appBar: AppBar(title: Text(isEnglish ? 'Cart' : '購物車')),
      body: ListView.builder(
        itemCount: cart.length,
        itemBuilder: (context, i) {
          final key = cart.keys.elementAt(i);
          final qty = cart.values.elementAt(i);
          final parts = key.split('|');
          final category = parts[0];
          final zh = parts[1];
          final item = menuData[category]!.firstWhere((e) => e['zh'] == zh);
          final price = item['price'] is String && item['price'].contains('/')
              ? int.parse(item['price'].split('/').first)
              : item['price'] as int;

          return ListTile(
            title: Text(isEnglish ? item['en'] : item['zh']),
            subtitle: Text('MOP $price × $qty = MOP ${price * qty}'),
            trailing: Text('×$qty'),
          );
        },
      ),
    );
  }
}

// ========================================
// 結帳頁面（模擬下單）
// ========================================
class CheckoutScreen extends StatelessWidget {
  final Map<String, int> cart;
  final double totalPrice;
  final bool isEnglish;

  const CheckoutScreen({
    required this.cart,
    required this.totalPrice,
    required this.isEnglish,
    super.key,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text(isEnglish ? 'Checkout' : '結帳')),
      body: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          children: [
            const Text('初見小廚', style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold)),
            const SizedBox(height: 10),
            const Text('地址：澳門司打口水字巷61號永利大廈地下B鋪'),
            const Text('外賣電話：6388 0338'),
            const Divider(height: 40),
            Expanded(
              child: ListView.builder(
                itemCount: cart.length,
                itemBuilder: (c, i) {
                  final key = cart.keys.elementAt(i);
                  final qty = cart.values.elementAt(i);
                  final parts = key.split('|');
                  final item = menuData[parts[0]]!.firstWhere((e) => e['zh'] == parts[1]);
                  final price = item['price'] is String && item['price'].contains('/')
                      ? int.parse(item['price'].split('/').first)
                      : item['price'];
                  return ListTile(
                    title: Text(isEnglish ? item['en'] : item['zh']),
                    trailing: Text('×$qty  MOP ${price * qty}'),
                  );
                },
              ),
            ),
            const Divider(),
            Text('總額：MOP ${totalPrice.toStringAsFixed(0)}',
                style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
            const SizedBox(height: 30),
            ElevatedButton(
              style: ElevatedButton.styleFrom(minimumSize: const Size(double.infinity, 56)),
              onPressed: () {
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(content: Text(isEnglish ? 'Order submitted! We will call you shortly.' : '訂單已提交！我們會盡快致電確認')),
                );
                Navigator.popUntil(context, (route) => route.isFirst);
              },
              child: Text(isEnglish ? 'Submit Order (Cash on delivery)' : '提交訂單（貨到付款）'),
            ),
          ],
        ),
      ),
    );
  }
}
